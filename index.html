<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cycle Tracker</title>
  <style>
    @font-face{font-family:'HJSS';src:url('HJSS.ttf') format('truetype')}
    :root{
      --shade-period:#f4dfe4;
      --shade-ovulation:#b5c0e3;
      --circle-color:#E1a3b3;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{display:flex;align-items:center;justify-content:center;height:100vh;background:#f9f9f9;font-family:'HJSS',sans-serif}
    .wrapper{width:100%;max-width:400px;background:#fff;border-radius:8px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem}
    button.nav{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#555}
    #month-year{cursor:pointer;font-weight:bold}
    /* 여백 늘린 부분 */
    .weekdays{display:grid;grid-template-columns:repeat(7,1fr);margin-top:1.5rem;margin-bottom:1rem}
    .weekdays div{text-align:center;padding:0.5rem 0}
    .weekdays .sun{color:#cd8d8d}
    .weekdays .sat{color:#7373b2}
    #calendar{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:1rem}
    #calendar div{text-align:center;padding:0.5rem 0;cursor:pointer;position:relative;color:#333}
    #calendar .sun{color:#cd8d8d}
    #calendar .sat{color:#7373b2}
    .period-range{background:var(--shade-period)}
    .period-circle{background:var(--circle-color);border-radius:50%}
    .ovulation-circle{background:var(--shade-ovulation);border-radius:50%}
    #message-box{text-align:center;font-size:0.9rem;color:#555;min-height:2em}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCpkhJyp2qPyr-duuda-VNeMj26YjfdjoM",
      authDomain: "nagi-cycle.firebaseapp.com",
      databaseURL: "https://nagi-cycle-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nagi-cycle",
      storageBucket: "nagi-cycle.firebasestorage.app",
      messagingSenderId: "428094469503",
      appId: "1:428094469503:web:3c1e10b1fcb876077bd64a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <div class="wrapper">
    <header>
      <button class="nav" id="prev">&larr;</button>
      <div id="month-year"></div>
      <button class="nav" id="next">&rarr;</button>
    </header>
    <div class="weekdays">
      <div class="sun">SUN</div><div>MON</div><div>TUE</div>
      <div>WED</div><div>THU</div><div>FRI</div><div class="sat">SAT</div>
    </div>
    <div id="calendar"></div>
    <div id="message-box"></div>
  </div>
  <script>
    (()=>{
      const ref = db.ref('users/anonymous/cycleDates');
      const messages = [
        "너의 몸은 너보다 더 많은 언어를 안다.",
        "잠시 멈춰 숨 쉬는 것만으로도 충분할 때가 있다.",
        "이 또한 지나가리라, 그 안에서 너는 더 단단해진다."
      ];
      let dates = [], avgCycle = 0, view = new Date();
      const elMonthYear = document.getElementById('month-year');
      const elCalendar  = document.getElementById('calendar');
      const elMessage   = document.getElementById('message-box');
      const pick = ()=> messages[Math.floor(Math.random()*messages.length)];

      document.getElementById('prev').addEventListener('click',()=>{
        view.setMonth(view.getMonth()-1);
        render();
      });
      document.getElementById('next').addEventListener('click',()=>{
        view.setMonth(view.getMonth()+1);
        render();
      });
      elMonthYear.addEventListener('click',()=>{
        view = new Date();
        render();
      });

      ref.on('value',snap=>{
        const val = snap.val()||{};
        dates = Object.keys(val)
          .filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k))
          .sort();
        if(dates.length>=2){
          const diffs = dates.slice(1).map((d,i)=>
            (new Date(d)-new Date(dates[i]))/86400000
          );
          avgCycle = Math.round(diffs.reduce((a,b)=>a+b)/diffs.length);
        }
        render();
        elMessage.textContent = pick();
      });

      function render(){
        const y = view.getFullYear(), m = view.getMonth();
        elMonthYear.textContent = `${y}년 ${m+1}월`;
        elCalendar.innerHTML = '';
        const firstDay = new Date(y,m,1).getDay();
        const total   = new Date(y,m+1,0).getDate();
        for(let i=0;i<firstDay;i++) elCalendar.appendChild(document.createElement('div'));

        const lastDate   = dates.length? new Date(dates.at(-1)) : null;
        const nextPeriod = lastDate? new Date(lastDate.getTime()+avgCycle*86400000) : null;
        const startP     = nextPeriod;
        const endP       = nextPeriod? new Date(startP.getTime()+4*86400000) : null;
        const ovDay      = nextPeriod? new Date(nextPeriod.getTime()-14*86400000) : null;

        for(let d=1; d<=total; d++){
          const cell = document.createElement('div');
          const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          cell.textContent = d;
          // 주말 색상
          const w = new Date(y,m,d).getDay();
          if(w===0) cell.classList.add('sun');
          else if(w===6) cell.classList.add('sat');
          // 클릭·터치 이벤트
          const toggle = ()=>{
            if(dates.includes(ds)) ref.child(ds).remove();
            else ref.child(ds).set(true);
          };
          cell.addEventListener('pointerup', e=>{ e.preventDefault(); toggle(); });
          // 예상 기간 음영
          const cd = new Date(y,m,d).getTime();
          if(startP && cd>=startP.getTime() && cd<=endP.getTime()) cell.classList.add('period-range');
          if(startP && (cd===startP.getTime()||cd===endP.getTime())) cell.classList.add('period-circle');
          if(ovDay && cd===ovDay.getTime()) cell.classList.add('ovulation-circle');
          elCalendar.appendChild(cell);
        }
      }
    })();
  </script>
</body>
</html>
