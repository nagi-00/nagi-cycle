<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cycle Tracker</title>
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('HJSS.ttf') format('truetype');
    }
    :root {
      --shade-period: #f4dfe4;
      --shade-ovulation: #b5c0e3;
      --circle-color: #E1a3b3;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      display:flex; align-items:center; justify-content:center;
      height:100vh; background:#f9f9f9; font-family:'HJSS',sans-serif;
    }
    .wrapper {
      width:100%; max-width:400px; background:#fff;
      border-radius:8px; padding:1rem;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    header {
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:1rem;
    }
    button.nav {
      background:none; border:none; font-size:1.5rem;
      cursor:pointer; color:#555;
    }
    #month-year { cursor:pointer; font-weight:bold }

    .weekdays {
      display:grid; grid-template-columns:repeat(7,1fr);
      margin-top:2rem; margin-bottom:1rem;
    }
    .weekdays div {
      text-align:center; padding:0.5rem 0;
    }
    .weekdays .sun { color:#cd8d8d }
    .weekdays .sat { color:#7373b2 }
    .weekdays div:not(.sun):not(.sat) { color:#333 }

    #calendar {
      display:grid; grid-template-columns:repeat(7,1fr);
      margin-bottom:1rem; gap:0;
    }
    /* 빈 칸 */
    #calendar button.placeholder {
      visibility:hidden; width:100%; aspect-ratio:1/1;
      border:none; background:transparent; cursor:default;
    }
    /* 날짜 버튼 */
    #calendar button.day {
      width:100%; aspect-ratio:1/1;
      display:flex; align-items:center; justify-content:center;
      background-color:transparent; border:none; cursor:pointer;
      font-size:calc(1rem - 1pt); color:#333; position:relative;
    }
    #calendar button.sun.day { color:#cd8d8d }
    #calendar button.sat.day { color:#7373b2 }

    /* 생리기간 음영과 원 */
    #calendar button.day.period-range {
      background-color: var(--shade-period) !important;
    }
    #calendar button.day.period-circle {
      background-color: var(--circle-color) !important;
      border-radius: 50% !important;
    }
    /* 배란기간 음영과 원 */
    #calendar button.day.ovulation-range {
      background-color: var(--shade-ovulation) !important;
    }
    #calendar button.day.ovulation-circle {
      background-color: var(--shade-ovulation) !important;
      border-radius: 50% !important;
    }

    #message-box {
      text-align:center; font-size:0.9rem; color:#555;
      min-height:2em;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCpkhJyp2qPyr-duuda-VNeMj26YjfdjoM",
      authDomain: "nagi-cycle.firebaseapp.com",
      databaseURL: "https://nagi-cycle-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nagi-cycle",
      storageBucket: "nagi-cycle.firebasestorage.app",
      messagingSenderId: "428094469503",
      appId: "1:428094469503:web:3c1e10b1fcb876077bd64a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <div class="wrapper">
    <header>
      <button class="nav" id="prev">&larr;</button>
      <div id="month-year"></div>
      <button class="nav" id="next">&rarr;</button>
    </header>
    <div class="weekdays">
      <div class="sun">SUN</div><div>MON</div><div>TUE</div>
      <div>WED</div><div>THU</div><div>FRI</div><div class="sat">SAT</div>
    </div>
    <div id="calendar"></div>
    <div id="message-box"></div>
  </div>

  <script>
    (()=>{
      const ref = db.ref('cycleDates');
      const periodMessages = [
        "몸이 차가워지기 쉬운 시기야. 따뜻한 차로 혈액 순환을 도와줘.",
        "에너지 소모가 크니 무리하지 말고 충분히 쉬어.",
        "감정 기복이 있을 수 있다. 자신에게도 관대해져 봐.",
        "코어 근육 이완을 위해 가벼운 스트레칭이 도움이 될 거야.",
        "잘 먹고 잘 쉬는 것이 지금 가장 중요한 활력제야.",
        "수분을 충분히 섭취하면 몸이 좀 더 편안해질 거야."
      ];
      const ovulationMessages = [
        "배란일 전후에는 호르몬 변화가 활발해. 피부 관리를 신경 써봐.",
        "에너지 레벨이 상승하는 시기야. 가벼운 운동으로 활력을 느껴봐.",
        "정신이 맑아지는 때이니 하고 싶던 일을 시도해봐.",
        "호르몬 균형을 위해 단백질 섭취에 주의를 기울여.",
        "감정이 예민해질 수 있어. 자기 자신에게 친절하게 대하길.",
        "자신감을 느끼기 좋은 시기야. 스스로를 응원해."
      ];

      let dates = [], avgCycle = 0, view = new Date();
      const elMonthYear = document.getElementById('month-year');
      const elCalendar  = document.getElementById('calendar');
      const elMessage   = document.getElementById('message-box');

      document.getElementById('prev').onclick = ()=>{ view.setMonth(view.getMonth()-1); render(); };
      document.getElementById('next').onclick = ()=>{ view.setMonth(view.getMonth()+1); render(); };
      elMonthYear.onclick = ()=>{ view = new Date(); render(); };

      ref.on('value', snap=>{
        const val = snap.val()||{};
        dates = Object.keys(val).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
        render();
      });

      function render(){
        const y = view.getFullYear(), m = view.getMonth();
        elMonthYear.textContent = `${y}년 ${m+1}월`;
        elCalendar.innerHTML = '';

        // 빈 칸
        const firstDay = new Date(y,m,1).getDay();
        for(let i=0;i<firstDay;i++){
          const ph = document.createElement('button');
          ph.disabled = true;
          ph.classList.add('placeholder');
          elCalendar.appendChild(ph);
        }

        const total = new Date(y,m+1,0).getDate();
        const now = new Date();

        for(let d=1; d<=total; d++){
          const btn = document.createElement('button');
          btn.classList.add('day');
          const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          btn.textContent = d;

          const w = new Date(y,m,d).getDay();
          if(w===0) btn.classList.add('sun');
          else if(w===6) btn.classList.add('sat');

          const cd = new Date(y,m,d).getTime();

          // 각 저장된 시작일에 대해 period & ovulation shading
          dates.forEach(startStr=>{
            const st = new Date(startStr);
            const pe = new Date(st.getTime()+6*86400000); // +6일
            const oc = new Date(st.getTime() + (avgCycle-14)*86400000); // ovDay
            // period-range
            if(cd>=st.getTime() && cd<=pe.getTime()){
              btn.classList.add('period-range');
            }
            // period-circle at boundaries
            if(cd===st.getTime()||cd===pe.getTime()){
              btn.classList.add('period-circle');
            }
            // ovulation-range: ovDay-1 ~ ovDay+1
            const ovStart = new Date(oc.getTime()-1*86400000);
            const ovEnd   = new Date(oc.getTime()+1*86400000);
            if(cd>=ovStart.getTime() && cd<=ovEnd.getTime()){
              btn.classList.add('ovulation-range');
            }
            // ovulation-circle at boundaries
            if(cd===ovStart.getTime()||cd===ovEnd.getTime()){
              btn.classList.add('ovulation-circle');
            }
          });

          btn.onclick = ()=>{
            if(dates.includes(ds)){
              // remove this start
              ref.child(ds).remove();
            } else {
              // add new start
              ref.child(ds).set(true);
            }
          };

          elCalendar.appendChild(btn);
        }

        // 메시지: 오늘이 어느 구간인지 확인
        let msg = '';
        dates.forEach(startStr=>{
          const st = new Date(startStr);
          const pe = new Date(st.getTime()+6*86400000);
          const oc = new Date(st.getTime() + (avgCycle-14)*86400000);
          const ovStart = new Date(oc.getTime()-1*86400000);
          const ovEnd   = new Date(oc.getTime()+1*86400000);
          if(now>=st && now<=pe){
            msg = periodMessages[Math.floor(Math.random()*periodMessages.length)];
          } else if(now>=ovStart && now<=ovEnd){
            msg = ovulationMessages[Math.floor(Math.random()*ovulationMessages.length)];
          }
        });
        elMessage.textContent = msg;
      }
    })();
  </script>
</body>
</html>
