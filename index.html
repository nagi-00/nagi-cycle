<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cycle Tracker</title>
  <style>
    @font-face {
      font-family: 'HJSS';
      src: url('HJSS.ttf') format('truetype');
    }
    :root {
      --shade-period: #f4dfe4;
      --circle-color: #E1a3b3;
      --shade-ovulation: #b5c0e3;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      display:flex; align-items:center; justify-content:center;
      height:100vh; background:#f9f9f9; font-family:'HJSS',sans-serif;
    }
    .wrapper {
      width:100%; max-width:400px; background:#fff;
      border-radius:8px; padding:1rem;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    header {
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:1rem;
    }
    button.nav {
      background:none; border:none; font-size:1.5rem;
      cursor:pointer; color:#555;
    }
    #month-year { cursor:pointer; font-weight:bold }

    .weekdays {
      display:grid; grid-template-columns:repeat(7,1fr);
      margin-top:2rem; margin-bottom:1rem;
    }
    .weekdays div {
      text-align:center; padding:0.5rem 0;
    }
    .weekdays .sun { color:#cd8d8d }
    .weekdays .sat { color:#7373b2 }
    .weekdays div:not(.sun):not(.sat) { color:#333 }

    #calendar {
      display:grid; grid-template-columns:repeat(7,1fr);
      margin-bottom:1rem; gap:0;
    }
    .placeholder {
      visibility:hidden; width:100%; aspect-ratio:1/1;
    }
    .day {
      position:relative;
      width:100%; aspect-ratio:1/1;
      display:flex; align-items:center; justify-content:center;
      background:transparent; border:none; cursor:pointer;
      font-size:calc(1rem - 1pt); color:#333;
    }
    .sun.day { color:#cd8d8d }
    .sat.day { color:#7373b2 }

    /* 1) 연속된 연한 음영 */
    #calendar .day.period-range {
      background-color: var(--shade-period) !important;
    }
    /* 2) 시작/끝일 위의 작은 원 */
    #calendar .day.period-circle::before {
      content: '';
      position: absolute;
      width: 70%;
      height: 70%;
      top: 15%;
      left: 15%;
      background-color: var(--circle-color);
      border-radius: 50%;
      z-index: 0;
    }
    /* 3) 배란일 원 */
    #calendar .day.ovulation-circle::before {
      content: '';
      position: absolute;
      width: 70%;
      height: 70%;
      top: 15%;
      left: 15%;
      background-color: var(--shade-ovulation);
      border-radius: 50%;
      z-index: 0;
    }
    /* 4) 원 안의 숫자는 흰색 */
    #calendar .day.period-circle,
    #calendar .day.ovulation-circle {
      color: #fff !important;
      z-index: 1;
    }

    #message-box {
      text-align:center; font-size:0.9rem; color:#555;
      min-height:2em;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCpkhJyp2qPyr-duuda-VNeMj26YjfdjoM",
      authDomain: "nagi-cycle.firebaseapp.com",
      databaseURL: "https://nagi-cycle-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nagi-cycle",
      storageBucket: "nagi-cycle.firebasestorage.app",
      messagingSenderId: "428094469503",
      appId: "1:428094469503:web:3c1e10b1fcb876077bd64a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <div class="wrapper">
    <header>
      <button class="nav" id="prev">&larr;</button>
      <div id="month-year"></div>
      <button class="nav" id="next">&rarr;</button>
    </header>
    <div class="weekdays">
      <div class="sun">SUN</div><div>MON</div><div>TUE</div>
      <div>WED</div><div>THU</div><div>FRI</div><div class="sat">SAT</div>
    </div>
    <div id="calendar"></div>
    <div id="message-box"></div>
  </div>

  <script>
    (()=>{
      const PERIOD_DAYS      = 6;   // 시작일 포함 총 7일
      const OVULATION_OFFSET = 14;  // 시작일부터 14일째

      const periodMessages = [ /* … */ ];
      const ovulationMessages = [ /* … */ ];

      const ref       = db.ref('cycleDates');
      let dates       = [];
      let viewDate    = new Date();
      const elCal     = document.getElementById('calendar');
      const elMonth   = document.getElementById('month-year');
      const elMessage = document.getElementById('message-box');
      document.getElementById('prev').onclick = ()=>{ viewDate.setMonth(viewDate.getMonth()-1); render(); };
      document.getElementById('next').onclick = ()=>{ viewDate.setMonth(viewDate.getMonth()+1); render(); };
      elMonth.onclick = ()=>{ viewDate = new Date(); render(); };

      ref.on('value', snap=>{
        dates = Object.keys(snap.val()||{})
          .filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort();
        render();
      });

      function toStr(d){
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      }

      function render(){
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        elMonth.textContent = `${y}년 ${m+1}월`;
        elCal.innerHTML = '';

        // 빈칸
        const startWeek = new Date(y,m,1).getDay();
        for(let i=0;i<startWeek;i++){
          const ph = document.createElement('div');
          ph.classList.add('placeholder');
          elCal.appendChild(ph);
        }

        // 한 번에 셋 계산
        const periodSet  = new Set();
        const circleSet  = new Set();
        const ovulaSet   = new Set();
        dates.forEach(startStr=>{
          const st = new Date(startStr);
          // 연속 음영
          for(let i=0;i<=PERIOD_DAYS;i++){
            const tmp = new Date(st);
            tmp.setDate(tmp.getDate()+i);
            periodSet.add(toStr(tmp));
          }
          // 시작·끝 원
          circleSet.add(startStr);
          const end = new Date(st);
          end.setDate(end.getDate()+PERIOD_DAYS);
          circleSet.add(toStr(end));
          // 배란일 원
          const ov = new Date(st);
          ov.setDate(ov.getDate()+OVULATION_OFFSET);
          ovulaSet.add(toStr(ov));
        });

        const daysInMonth = new Date(y,m+1,0).getDate();
        const today       = new Date();

        for(let d=1; d<=daysInMonth; d++){
          const btn = document.createElement('button');
          btn.classList.add('day');
          const curr = new Date(y,m,d), ds = toStr(curr);
          btn.textContent = d;
          // 주말 색
          const wd = curr.getDay();
          if(wd===0) btn.classList.add('sun');
          else if(wd===6) btn.classList.add('sat');
          // 음영 & 원
          if(periodSet.has(ds))    btn.classList.add('period-range');
          if(circleSet.has(ds))    btn.classList.add('period-circle');
          if(ovulaSet.has(ds))     btn.classList.add('ovulation-circle');
          // 클릭 토글
          btn.onclick = ()=>{
            if(dates.includes(ds)) ref.child(ds).remove();
            else ref.child(ds).set(true);
          };
          elCal.appendChild(btn);
        }

        // 메시지
        let msg = '';
        dates.forEach(startStr=>{
          const stMs = new Date(startStr).getTime();
          const endMs= stMs + PERIOD_DAYS*86400000;
          const ovMs = stMs + OVULATION_OFFSET*86400000;
          const nowMs= today.getTime();
          if(nowMs>=stMs && nowMs<=endMs){
            msg = periodMessages[Math.floor(Math.random()*periodMessages.length)];
          } else if(nowMs===ovMs){
            msg = ovulationMessages[Math.floor(Math.random()*ovulationMessages.length)];
          }
        });
        elMessage.textContent = msg;
      }
    })();
  </script>
</body>
</html>
